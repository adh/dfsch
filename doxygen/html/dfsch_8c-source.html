<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>dfsch: dfsch.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>dfsch.c</h1><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment"> * dfsch - DFox's quick and dirty scheme implementation</span>
00003 <span class="comment"> * Copyright (C) 2005 Ales Hakl</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
00006 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00007 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00008 <span class="comment"> * (at your option) any later version.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00011 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00013 <span class="comment"> * GNU General Public License for more details.</span>
00014 <span class="comment"> *</span>
00015 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00016 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00017 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> */</span>
00020 
00023 <span class="preprocessor">#include "<a class="code" href="dfsch_8h.html">dfsch.h</a>"</span>
00024 
00025 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00026 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00027 <span class="preprocessor">#include &lt;string.h&gt;</span>
00028 
00029 <span class="comment">//#define PARSER_DEBUG</span>
00030 <span class="comment">//#define GC_DEBUG</span>
00031 <span class="comment">//#define OBJ_LIST_DEBUG</span>
00032 
00033 <span class="keyword">typedef</span> <span class="keyword">enum</span> {
00034   PAIR,
00035   SYMBOL,
00036   NUMBER,
00037   STRING,
00038   PRIMITIVE,
00039   CLOSURE,
00040   MACRO,
00041   FLOW_MACRO,
00042   EXCEPTION <span class="comment">// define new types here</span>
00043 } type_t ;
00044 
00045 <span class="keyword">typedef</span> <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a> object_t;
00046 <span class="keyword">typedef</span> <a class="code" href="dfsch_8h.html#a2">dfsch_ctx_t</a> context_t;
00047 
00048 <span class="keyword">typedef</span> <span class="keyword">struct </span>symbol_t symbol_t;
00049 
00050 <span class="keyword">struct </span>symbol_t{
00051   <span class="keywordtype">char</span> *data;
00052   object_t *next;
00053   object_t *prev;
00054 };
00055 
00056 <span class="keyword">static</span> object_t *global_symbol_table=NULL;
00057 
00058 
00059 <span class="keyword">struct </span><a class="code" href="dfsch_8h.html#a2">dfsch_ctx_t</a>{
00060   object_t* env;
00061 };
00062 
00063 <span class="keyword">typedef</span> <span class="keyword">struct </span>pair_t{
00064   object_t *car;
00065   object_t *cdr;
00066 } pair_t;
00067 
00068 <span class="keyword">typedef</span> <a class="code" href="dfsch_8h.html#a5">dfsch_primitive_t</a> primitive_t;
00069 
00070 <span class="keyword">typedef</span> <span class="keyword">struct </span>closure_t{
00071   object_t* args;
00072   object_t* code;
00073   object_t* env;
00074 } closure_t;
00075 
00076 <span class="keyword">typedef</span> <span class="keyword">struct </span>exception_t{
00077   object_t *type;
00078   object_t *data;
00079 } exception_t; 
00080 
00081 <span class="keyword">struct </span><a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>{
00082   type_t type;
00083   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> marked;
00084   <span class="keyword">union </span>{
00085     pair_t pair;
00086     symbol_t symbol;
00087     <span class="keywordtype">double</span> number;
00088     <span class="keywordtype">char</span>* string;
00089     primitive_t primitive;
00090     closure_t closure;
00091     object_t *macro;
00092     exception_t exception;
00093   } data;
00094 };
00095 
00096 
00097 <span class="keyword">static</span> <span class="keywordtype">char</span>* stracat(<span class="keywordtype">char</span>* a, <span class="keywordtype">char</span>* b){
00098   size_t s = strlen(a)+strlen(b)+1;
00099   <span class="keywordtype">char</span>* o = malloc(s);
00100   strncpy(o,a,s);
00101   strncat(o,b,s);
00102   <span class="keywordflow">return</span> o;
00103 }
00104 
00105 <span class="keyword">static</span> <span class="keywordtype">char</span>* strneko(<span class="keywordtype">char</span>* a, <span class="keywordtype">char</span>* b){ <span class="comment">// ^_^</span>
00106   <span class="keywordtype">char</span> * s = stracat(a,b);
00107   free(a);
00108   free(b);
00109   <span class="keywordflow">return</span> s;
00110 }
00111 <span class="keyword">static</span> <span class="keywordtype">char</span>* strneko_l(<span class="keywordtype">char</span>* a, <span class="keywordtype">char</span>* b){ <span class="comment">// ^_^</span>
00112   <span class="keywordtype">char</span> * s = stracat(a,b);
00113   free(a);
00114   <span class="keywordflow">return</span> s;
00115 }
00116 <span class="keyword">static</span> <span class="keywordtype">char</span>* strneko_r(<span class="keywordtype">char</span>* a, <span class="keywordtype">char</span>* b){ <span class="comment">// ^_^</span>
00117   <span class="keywordtype">char</span> * s = stracat(a,b);
00118   free(b);
00119   <span class="keywordflow">return</span> s;
00120 }
00121 <span class="keyword">static</span> <span class="keywordtype">char</span>* stracpy(<span class="keywordtype">char</span>* x){
00122   <span class="keywordtype">char</span> *b;
00123   size_t s = strlen(x)+1;
00124   b = malloc(s);
00125   strncpy(b,x,s);
00126   <span class="keywordflow">return</span> b;
00127 }
00128 <span class="keyword">static</span> <span class="keywordtype">char</span>* strancpy(<span class="keywordtype">char</span>* x, size_t n){
00129   <span class="keywordtype">char</span> *b;
00130   size_t s = n+1;
00131   b = malloc(s);
00132   strncpy(b,x,s-1);
00133   b[s-1]=0;
00134   <span class="keywordflow">return</span> b;
00135 }
00136 <span class="keyword">static</span> <span class="keywordtype">char</span>* straquote(<span class="keywordtype">char</span> *s){
00137   <span class="keywordtype">char</span> *b = malloc(strlen(s)*3+3);
00138   <span class="keywordtype">char</span> *i = b;
00139 
00140   *i=<span class="charliteral">'"'</span>;
00141   i++;
00142 
00143   <span class="keywordflow">while</span> (*s){
00144     <span class="keywordflow">switch</span> (*s){
00145     <span class="keywordflow">case</span> <span class="charliteral">'"'</span>:
00146       i[0]=<span class="charliteral">'\\'</span>;
00147       i[1]=<span class="charliteral">'"'</span>;
00148       i+=2;
00149     <span class="keywordflow">default</span>:
00150       *i = *s;
00151       ++i;
00152     }
00153     s++;
00154   }
00155 
00156   *i=<span class="charliteral">'"'</span>;
00157   i[1]=0;
00158 
00159   <span class="keywordflow">return</span> b;
00160 
00161 }
00162 
00163 <span class="preprocessor">#define EXCEPTION_CHECK(x) {if (dfsch_object_exception_p(x)) return x;}</span>
00164 <span class="preprocessor"></span>
00165 
00166 <span class="keyword">static</span> <span class="keywordtype">void</span> object_destroy(object_t* obj){
00167 <span class="preprocessor">#ifdef OBJ_LIST_DEBUG</span>
00168 <span class="preprocessor"></span>  printf(<span class="stringliteral">";; Destroy: %p\n"</span>,obj);
00169 <span class="preprocessor">#endif</span>
00170 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (!obj)
00171     <span class="keywordflow">return</span>;
00172 
00173   <span class="keywordflow">switch</span> (obj-&gt;type){
00174   <span class="keywordflow">case</span> STRING:
00175     free(obj-&gt;data.string);
00176     <span class="keywordflow">break</span>;
00177   <span class="keywordflow">case</span> SYMBOL:
00178     <span class="comment">//return; // FIXME: this code is somehow broken:</span>
00179     free(obj-&gt;data.symbol.data);
00180 
00181     <span class="keywordflow">if</span> (obj-&gt;data.symbol.prev){
00182       obj-&gt;data.symbol.prev-&gt;data.symbol.next = obj-&gt;data.symbol.next;
00183     }<span class="keywordflow">else</span>{
00184       global_symbol_table = obj-&gt;data.symbol.next;
00185     }
00186 
00187     <span class="keywordflow">if</span> (obj-&gt;data.symbol.next){
00188       obj-&gt;data.symbol.next-&gt;data.symbol.prev = obj-&gt;data.symbol.next;
00189     }
00190 
00191     <span class="keywordflow">break</span>;
00192     
00193   }
00194 
00195   free(obj);
00196 }
00197 
00198 <span class="keyword">typedef</span> <span class="keyword">struct </span>objlist_t objlist_t;
00199 
00200 <span class="keyword">struct </span>objlist_t{
00201   object_t* object;
00202   objlist_t* next;
00203 };
00204 
00205 
00206 <span class="keyword">static</span> objlist_t* gc_objects=NULL;
00207 <span class="keyword">static</span> objlist_t* gc_roots=NULL;
00208 
00209 
00210 <span class="keyword">static</span> <span class="keywordtype">void</span> gc_mark(object_t* obj){
00211 <span class="preprocessor">#ifdef GC_DEBUG</span>
00212 <span class="preprocessor"></span>  printf(<span class="stringliteral">";; Mark: %p\n"</span>,obj);
00213 <span class="preprocessor">#endif</span>
00214 <span class="preprocessor"></span>
00215   <span class="keywordflow">if</span> (!obj)
00216     <span class="keywordflow">return</span>;
00217 
00218   <span class="keywordflow">if</span> (obj-&gt;marked)
00219     <span class="keywordflow">return</span>;
00220 
00221   obj-&gt;marked = 1;
00222 
00223   <span class="keywordflow">switch</span> (obj-&gt;type){
00224   <span class="keywordflow">case</span> PAIR:
00225     gc_mark(obj-&gt;data.pair.car);
00226     gc_mark(obj-&gt;data.pair.cdr);
00227     <span class="keywordflow">break</span>;
00228   <span class="keywordflow">case</span> CLOSURE:
00229     gc_mark(obj-&gt;data.closure.args);
00230     gc_mark(obj-&gt;data.closure.code);
00231     gc_mark(obj-&gt;data.closure.env);
00232     <span class="keywordflow">break</span>;
00233   <span class="keywordflow">case</span> MACRO:
00234   <span class="keywordflow">case</span> FLOW_MACRO:
00235     gc_mark(obj-&gt;data.macro);
00236     <span class="keywordflow">break</span>;
00237   <span class="keywordflow">case</span> EXCEPTION:
00238     gc_mark(obj-&gt;data.exception.type);
00239     gc_mark(obj-&gt;data.exception.data);
00240   }
00241 }
00242 
00243 <span class="preprocessor">#ifdef OBJ_LIST_DEBUG</span>
00244 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> dump_obj_list(objlist_t* list){
00245   objlist_t *i = list;
00246   printf(<span class="stringliteral">";; ObjList dump: %p\n"</span>,list);
00247 
00248   <span class="keywordflow">while</span> (i){
00249     printf(<span class="stringliteral">";; ObjList item: %p =&gt; %p\n"</span>,i,i-&gt;object);
00250     i = i-&gt;next;
00251   }
00252 
00253 }
00254 <span class="preprocessor">#endif</span>
00255 <span class="preprocessor"></span>
00256 
00257 
00258 <span class="keywordtype">int</span> dfsch_gc(){
00259   objlist_t* i_o=gc_objects;
00260   objlist_t *j, *d;
00261   objlist_t* i_r=gc_roots;
00262   <span class="keywordtype">int</span> counter = 0;
00263 
00264   <span class="keywordflow">while</span> (i_o){
00265     i_o-&gt;object-&gt;marked = 0;
00266     i_o = i_o-&gt;next;
00267   }
00268 
00269   <span class="keywordflow">while</span> (i_r){
00270     gc_mark(i_r-&gt;object);
00271     i_r = i_r-&gt;next;
00272   }
00273 
00274   i_o=gc_objects;
00275 
00276   j = NULL;
00277 
00278   <span class="keywordflow">while</span> (i_o){
00279 <span class="preprocessor">#ifdef GC_DEBUG</span>
00280 <span class="preprocessor"></span>    printf(<span class="stringliteral">";; Post-Mark: %p = %d\n"</span>,i_o-&gt;object,i_o-&gt;object-&gt;marked);
00281 <span class="preprocessor">#endif</span>
00282 <span class="preprocessor"></span>
00283     <span class="keywordflow">if</span> (!i_o-&gt;object-&gt;marked){
00284       d = i_o;
00285       <span class="keywordflow">if</span> (j){
00286         i_o = j-&gt;next = i_o-&gt;next;
00287       }<span class="keywordflow">else</span>{
00288         i_o = gc_objects = i_o-&gt;next;
00289       }
00290 
00291       object_destroy(d-&gt;object);
00292       free(d);
00293       ++counter;
00294     }<span class="keywordflow">else</span>{
00295       j = i_o;
00296       i_o = i_o-&gt;next;
00297     }
00298   }
00299 
00300   <span class="keywordflow">return</span> counter;
00301 
00302 }
00303 <span class="keyword">static</span> <span class="keywordtype">void</span> register_object(object_t* obj){
00304   objlist_t *o = malloc(<span class="keyword">sizeof</span>(objlist_t));
00305 
00306   o-&gt;next = gc_objects;
00307   o-&gt;object = obj;
00308   gc_objects = o;
00309 
00310 <span class="preprocessor">#ifdef OBJ_LIST_DEBUG</span>
00311 <span class="preprocessor"></span>    printf(<span class="stringliteral">";; Register-object: %p, type %d\n"</span>,obj, obj-&gt;type);
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314 
00315 }
00316 
00317 
00318 
00319 <span class="keywordtype">void</span> <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(object_t* obj){
00320   objlist_t *o = malloc(<span class="keyword">sizeof</span>(objlist_t));
00321 
00322   o-&gt;next = gc_roots;
00323   o-&gt;object = obj;
00324   gc_roots = o;
00325 }
00326 <span class="keywordtype">void</span> <a class="code" href="dfsch_8h.html#a8">dfsch_object_unref</a>(object_t* obj){
00327   objlist_t *i,*d,*j;
00328 
00329   i = gc_roots;
00330   j = NULL;
00331 
00332   <span class="keywordflow">while</span> (i){
00333     <span class="keywordflow">if</span> (i-&gt;object==obj){
00334       d = i;
00335       <span class="keywordflow">if</span> (j){
00336         i = j-&gt;next = i-&gt;next;
00337       }<span class="keywordflow">else</span>{
00338         i = gc_roots = i-&gt;next;
00339       }
00340 <span class="preprocessor">#ifdef OBJ_LIST_DEBUG</span>
00341 <span class="preprocessor"></span>    printf(<span class="stringliteral">";; Unref-object: %p, type %d\n"</span>,obj, obj-&gt;type);
00342 <span class="preprocessor">#endif</span>
00343 <span class="preprocessor"></span>
00344       free(d);
00345       <span class="keywordflow">break</span>;
00346     }<span class="keywordflow">else</span>{
00347       j = i;
00348       i = i-&gt;next;
00349     }
00350   }
00351 <span class="preprocessor">#ifdef OBJ_LIST_DEBUG</span>
00352 <span class="preprocessor"></span>  dump_obj_list(gc_roots);
00353 <span class="preprocessor">#endif</span>
00354 <span class="preprocessor"></span>  
00355 
00356 
00357 }
00358 
00359 <span class="keywordtype">void</span> dfsch_object_all_unref(object_t* obj){
00360   objlist_t *i,*d,*j;
00361 
00362   i = gc_roots;
00363   j = NULL;
00364 
00365   <span class="keywordflow">while</span> (i){
00366     <span class="keywordflow">if</span> (i-&gt;object==obj){
00367       d = i;
00368       <span class="keywordflow">if</span> (j){
00369         i = j-&gt;next = i-&gt;next;
00370       }<span class="keywordflow">else</span>{
00371         i = gc_roots = i-&gt;next;
00372       }
00373 <span class="preprocessor">#ifdef OBJ_LIST_DEBUG</span>
00374 <span class="preprocessor"></span>    printf(<span class="stringliteral">";; Unref-object: %p, type %d\n"</span>,obj, obj-&gt;type);
00375 <span class="preprocessor">#endif</span>
00376 <span class="preprocessor"></span>
00377       free(d);
00378     }<span class="keywordflow">else</span>{
00379       j = i;
00380       i = i-&gt;next;
00381     }
00382   }
00383 <span class="preprocessor">#ifdef OBJ_LIST_DEBUG</span>
00384 <span class="preprocessor"></span>  dump_obj_list(gc_roots);
00385 <span class="preprocessor">#endif</span>
00386 <span class="preprocessor"></span>  
00387 
00388 }
00389 
00390 
00391 <span class="keyword">static</span> object_t* make_object(type_t type){
00392   object_t* o = malloc(<span class="keyword">sizeof</span>(object_t));
00393   <span class="keywordflow">if</span> (!o)
00394     <span class="keywordflow">return</span> NULL;
00395 
00396   o-&gt;type = type;
00397 
00398   register_object(o);
00399 
00400   <span class="keywordflow">return</span> o;
00401 }
00402 
00403 <span class="keywordtype">int</span> dfsch_eq_p(dfsch_object_t *a, dfsch_object_t *b){
00404   <span class="keywordflow">if</span> (a==b)
00405     <span class="keywordflow">return</span> 1;
00406 
00407   <span class="keywordflow">if</span> (!a)
00408     <span class="keywordflow">return</span> 0;
00409   <span class="keywordflow">if</span> (!b)
00410     <span class="keywordflow">return</span> 0;
00411   
00412   <span class="keywordflow">if</span> (a-&gt;type!=b-&gt;type)
00413     <span class="keywordflow">return</span> 0;
00414 
00415   <span class="keywordflow">switch</span>(a-&gt;type){
00416   <span class="keywordflow">case</span> NUMBER:
00417     <span class="keywordflow">return</span> (a-&gt;data.number == b-&gt;data.number);
00418   <span class="keywordflow">case</span> STRING:
00419     <span class="keywordflow">return</span> strcmp(a-&gt;data.string, b-&gt;data.string)==0?1:0;
00420   }
00421 
00422   <span class="keywordflow">return</span> 0;
00423   
00424 }
00425 
00426 <span class="keywordtype">int</span> dfsch_object_null_p(dfsch_object_t* obj){
00427   <span class="keywordflow">return</span> !obj;
00428 }
00429 <span class="keywordtype">int</span> dfsch_object_pair_p(dfsch_object_t* obj){
00430   <span class="keywordflow">if</span> (!obj)
00431     <span class="keywordflow">return</span> 0;
00432   <span class="keywordflow">return</span> obj-&gt;type == PAIR;
00433 }
00434 <span class="keywordtype">int</span> dfsch_object_atom_p(dfsch_object_t* obj){
00435   <span class="keywordflow">if</span> (!obj)
00436     <span class="keywordflow">return</span> 0;
00437   <span class="keywordflow">return</span> obj-&gt;type != PAIR;
00438 }
00439 <span class="keywordtype">int</span> dfsch_object_symbol_p(dfsch_object_t* obj){
00440   <span class="keywordflow">if</span> (!obj)
00441     <span class="keywordflow">return</span> 0;
00442   <span class="keywordflow">return</span> obj-&gt;type == SYMBOL;
00443 }
00444 <span class="keywordtype">int</span> dfsch_object_number_p(dfsch_object_t* obj){
00445   <span class="keywordflow">if</span> (!obj)
00446     <span class="keywordflow">return</span> 0;
00447   <span class="keywordflow">return</span> obj-&gt;type == NUMBER;
00448 }
00449 <span class="keywordtype">int</span> dfsch_object_string_p(dfsch_object_t* obj){
00450   <span class="keywordflow">if</span> (!obj)
00451     <span class="keywordflow">return</span> 0;
00452   <span class="keywordflow">return</span> obj-&gt;type == STRING;
00453 
00454 }
00455 <span class="keywordtype">int</span> dfsch_object_primitive_p(dfsch_object_t* obj){
00456   <span class="keywordflow">if</span> (!obj)
00457     <span class="keywordflow">return</span> 0;
00458   <span class="keywordflow">return</span> obj-&gt;type == PRIMITIVE;
00459 
00460 }
00461 <span class="keywordtype">int</span> dfsch_object_closure_p(dfsch_object_t* obj){
00462   <span class="keywordflow">if</span> (!obj)
00463     <span class="keywordflow">return</span> 0;
00464   <span class="keywordflow">return</span> obj-&gt;type == CLOSURE;
00465 }
00466 <span class="keywordtype">int</span> dfsch_object_procedure_p(dfsch_object_t* obj){
00467   <span class="keywordflow">if</span> (!obj)
00468     <span class="keywordflow">return</span> 0;
00469   <span class="keywordflow">return</span> obj-&gt;type == PRIMITIVE || obj-&gt;type == CLOSURE;
00470 }
00471 <span class="keywordtype">int</span> dfsch_object_macro_p(dfsch_object_t* obj){
00472   <span class="keywordflow">if</span> (!obj)
00473     <span class="keywordflow">return</span> 0;
00474   <span class="keywordflow">return</span> obj-&gt;type == MACRO;
00475 }
00476 
00477 <span class="keywordtype">int</span> dfsch_object_exception_p(dfsch_object_t* obj){
00478   <span class="keywordflow">if</span> (!obj)
00479     <span class="keywordflow">return</span> 0;
00480   <span class="keywordflow">return</span> obj-&gt;type == EXCEPTION;
00481 }
00482 
00483 
00484 
00485 <span class="comment">// Pairs</span>
00486 
00487 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_cons(dfsch_object_t* car, dfsch_object_t* cdr){
00488   object_t* p = make_object(PAIR);
00489   <span class="keywordflow">if</span> (!p)
00490     <span class="keywordflow">return</span> NULL;
00491 
00492 
00493   p-&gt;data.pair.car = car;
00494   p-&gt;data.pair.cdr = cdr;
00495 
00496   <span class="keywordflow">return</span> p;
00497 }
00498 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_car(dfsch_object_t* pair){
00499   <span class="keywordflow">if</span> (!pair || pair-&gt;type!=PAIR)
00500     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-pair"</span>),
00501                                 pair);
00502 
00503   <span class="keywordflow">return</span> pair-&gt;data.pair.car;
00504 }
00505 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_cdr(dfsch_object_t* pair){
00506   <span class="keywordflow">if</span> (!pair || pair-&gt;type!=PAIR)
00507     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-pair"</span>),
00508                                 pair);
00509 
00510   <span class="keywordflow">return</span> pair-&gt;data.pair.cdr;
00511 }
00512 
00513 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_set_car(dfsch_object_t* pair,
00514                               dfsch_object_t* car){
00515   <span class="keywordflow">if</span> (!pair || pair-&gt;type!=PAIR)
00516     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-pair"</span>),
00517                                 pair);
00518 
00519   <span class="keywordflow">if</span> (pair-&gt;data.pair.car!=car){
00520     pair-&gt;data.pair.car = car;
00521   }
00522   
00523   <span class="keywordflow">return</span> pair;
00524 
00525 }
00526 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_set_cdr(dfsch_object_t* pair,
00527                               dfsch_object_t* cdr){
00528   <span class="keywordflow">if</span> (!pair || pair-&gt;type!=PAIR)
00529     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-pair"</span>),
00530                                 pair);
00531   
00532   <span class="keywordflow">if</span> (pair-&gt;data.pair.cdr!=cdr){
00533     pair-&gt;data.pair.cdr = cdr;
00534   }
00535   
00536   <span class="keywordflow">return</span> pair;
00537 
00538 }
00539 
00540 <span class="comment">// Alists</span>
00541 
00542 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_assoc(dfsch_object_t *key,
00543                             dfsch_object_t *alist){
00544   <span class="keywordflow">if</span> (!alist || alist-&gt;type!=PAIR)
00545     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-pair"</span>),
00546                                 alist);
00547 
00548   object_t* i=alist;
00549   
00550   <span class="keywordflow">while</span> (i &amp;&amp; i-&gt;type==PAIR){
00551     <span class="keywordflow">if</span> (!i-&gt;data.pair.car || i-&gt;data.pair.car-&gt;type!=PAIR){
00552       <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-alist"</span>),
00553                                   alist);
00554     }
00555 
00556     <span class="keywordflow">if</span> (dfsch_eq_p(key,i-&gt;data.pair.car-&gt;data.pair.car)){
00557       <span class="keywordflow">return</span> i-&gt;data.pair.cdr;
00558     }
00559 
00560     i = i-&gt;data.pair.cdr;
00561   }
00562 
00563   <span class="keywordflow">return</span> NULL;
00564 
00565 }
00566 
00567 <span class="comment">// Numbers</span>
00568 
00569 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_make_number(<span class="keywordtype">double</span> num){
00570   object_t *n;
00571   n = make_object(NUMBER);
00572   <span class="keywordflow">if</span> (!n)
00573     <span class="keywordflow">return</span> NULL;
00574 
00575 
00576   n-&gt;data.number = num;
00577 
00578   <span class="keywordflow">return</span> n;
00579 }
00580 <span class="keywordtype">float</span> dfsch_number(dfsch_object_t *n){
00581   <span class="keywordflow">if</span> (!n || n-&gt;type!=NUMBER)
00582     <span class="keywordflow">return</span> 0.0;
00583 
00584   <span class="keywordflow">return</span> n-&gt;data.number;
00585 
00586 }
00587 
00588 <span class="comment">// Strings</span>
00589 
00590 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_make_string(<span class="keywordtype">char</span>* str){
00591   object_t *n;
00592   n = make_object(STRING);
00593   <span class="keywordflow">if</span> (!n)
00594     <span class="keywordflow">return</span> NULL;
00595 
00596 
00597   n-&gt;data.string = stracpy(str);
00598 
00599   <span class="keywordflow">return</span> n;
00600 }
00601 <span class="keywordtype">char</span>* dfsch_string(dfsch_object_t *n){
00602   <span class="keywordflow">if</span> (!n || n-&gt;type!=STRING)
00603     <span class="keywordflow">return</span> NULL;
00604 
00605   <span class="keywordflow">return</span> n-&gt;data.string;
00606 
00607 }
00608 
00609 
00610 <span class="comment">// Symbols</span>
00611 
00612 <span class="keyword">static</span> object_t* lookup_symbol(<span class="keywordtype">char</span> *symbol){
00613   object_t *i = global_symbol_table;
00614 
00615   <span class="keywordflow">while</span> (i){
00616     <span class="keywordflow">if</span> (strcasecmp(i-&gt;data.symbol.data, symbol)==0){
00617       <span class="keywordflow">return</span> i;
00618     }
00619     i = i-&gt;data.symbol.next;
00620   }
00621 
00622   <span class="keywordflow">return</span> NULL;
00623 }
00624 <span class="keyword">static</span> object_t* make_symbol(<span class="keywordtype">char</span> *symbol){
00625   object_t *s = make_object(SYMBOL);
00626   
00627   s-&gt;data.symbol.data = stracpy(symbol);
00628 
00629   s-&gt;data.symbol.prev = NULL;
00630   s-&gt;data.symbol.next = global_symbol_table;
00631   global_symbol_table = s;
00632 
00633   <span class="keywordflow">if</span> (s-&gt;data.symbol.next){
00634     s-&gt;data.symbol.next-&gt;data.symbol.prev = s;
00635   }
00636 
00637   <span class="keywordflow">return</span> s;
00638 }
00639 
00640 
00641 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_make_symbol(<span class="keywordtype">char</span>* symbol){
00642 
00643   object_t *s = lookup_symbol(symbol);
00644 
00645   <span class="keywordflow">if</span> (!s)
00646     s = make_symbol(symbol);
00647 
00648   <span class="keywordflow">return</span> s;
00649 
00650 }
00651 <span class="keywordtype">char</span>* dfsch_symbol(dfsch_object_t* symbol){
00652   <span class="keywordflow">if</span> (!symbol || symbol-&gt;type!=SYMBOL)
00653     <span class="keywordflow">return</span> NULL;
00654 
00655   <span class="keywordflow">return</span> symbol-&gt;data.symbol.data;
00656 }
00657 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_true(){
00658   <span class="keyword">static</span> object_t *cache = NULL;
00659   <span class="keywordflow">if</span> (cache)
00660     <span class="keywordflow">return</span> cache;
00661 
00662   cache = dfsch_make_symbol(<span class="stringliteral">"true"</span>);
00663   <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(cache);
00664   <span class="keywordflow">return</span> cache;
00665 }
00666 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_quote(){
00667   <span class="keyword">static</span> object_t *cache = NULL;
00668   <span class="keywordflow">if</span> (cache)
00669     <span class="keywordflow">return</span> cache;
00670 
00671   cache = dfsch_make_symbol(<span class="stringliteral">"quote"</span>);
00672   <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(cache);
00673   <span class="keywordflow">return</span> cache;
00674 }
00675 
00676 <span class="comment">// closures</span>
00677 
00678 <span class="keyword">extern</span> <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_lambda(dfsch_object_t* env,
00679                                     dfsch_object_t* args,
00680                                     dfsch_object_t* code){
00681   object_t *c = make_object(CLOSURE);
00682   <span class="keywordflow">if</span> (!c)
00683     <span class="keywordflow">return</span> NULL;
00684   
00685   c-&gt;data.closure.env = env;
00686   c-&gt;data.closure.args = args;
00687   c-&gt;data.closure.code = code;
00688 
00689   <span class="keywordflow">return</span> c;
00690   
00691 }
00692 
00693 <span class="comment">// native code</span>
00694 
00695 object_t* dfsch_make_primitive(<a class="code" href="dfsch_8h.html#a5">dfsch_primitive_t</a> prim){
00696   object_t* p = make_object(PRIMITIVE);
00697   <span class="keywordflow">if</span> (!p)
00698     <span class="keywordflow">return</span> NULL;
00699 
00700   p-&gt;data.primitive = prim;
00701 
00702   <span class="keywordflow">return</span> p;
00703 }
00704 
00705 <span class="comment">// macros</span>
00706 
00707 object_t* <a class="code" href="dfsch_8h.html#a39">dfsch_make_macro</a>(object_t *proc){
00708   object_t *m = make_object(MACRO);
00709   
00710   <span class="keywordflow">if</span> (!m)
00711     <span class="keywordflow">return</span> NULL;
00712 
00713   m-&gt;data.macro = proc;
00714 
00715   <span class="keywordflow">return</span> m;
00716 }
00717 object_t* dfsch_make_flow_macro(object_t *proc){
00718   object_t *m = make_object(FLOW_MACRO);
00719   
00720   <span class="keywordflow">if</span> (!m)
00721     <span class="keywordflow">return</span> NULL;
00722 
00723   m-&gt;data.macro = proc;
00724 
00725   <span class="keywordflow">return</span> m;
00726 }
00727 
00728 
00729 
00730 <span class="comment">// Error handling</span>
00731 
00732 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_make_exception(dfsch_object_t* type, 
00733                                      dfsch_object_t* data){
00734   object_t* e = make_object(EXCEPTION);
00735   <span class="keywordflow">if</span> (!e)
00736     <span class="keywordflow">return</span> NULL;
00737 
00738 
00739   e-&gt;data.exception.type=type;
00740   e-&gt;data.exception.data=data;
00741 
00742 
00743 
00744   <span class="keywordflow">return</span> e;
00745 }
00746 
00747 <span class="comment">// Expression parser</span>
00748 
00749 <span class="keyword">typedef</span> <span class="keyword">struct </span>token_t {
00750   <span class="keyword">enum</span> {
00751     T_OPEN,
00752     T_CLOSE,
00753     T_DOT,
00754     T_QUOTE,
00755     T_TERMINAL
00756   } type;
00757   object_t* data;
00758 } token_t;
00759 
00760 <span class="keyword">static</span> <span class="keywordtype">int</span> get_token(token_t* token, <span class="keywordtype">char</span> **str) {
00761   <span class="keywordflow">while</span> ((*str)[0]==<span class="charliteral">' '</span> || (*str)[0]==<span class="charliteral">'\t'</span> || (*str)[0]==<span class="charliteral">'\n'</span>)
00762     ++(*str);
00763 
00764   <span class="keywordflow">switch</span> ((*str)[0]){
00765   <span class="keywordflow">case</span> 0:
00766     <span class="keywordflow">return</span> 0;
00767   <span class="keywordflow">case</span> <span class="charliteral">'.'</span>:
00768     <span class="keywordflow">if</span> ((*str)[1]==<span class="charliteral">' '</span> || (*str)[1]==<span class="charliteral">'\t'</span> || (*str)[1]==<span class="charliteral">'\n'</span>){
00769       token-&gt;type=T_DOT;
00770       (*str)+=2;    
00771       <span class="keywordflow">return</span> 1;
00772 
00773     }
00774   <span class="keywordflow">case</span> <span class="charliteral">'0'</span>:
00775   <span class="keywordflow">case</span> <span class="charliteral">'1'</span>:
00776   <span class="keywordflow">case</span> <span class="charliteral">'2'</span>:
00777   <span class="keywordflow">case</span> <span class="charliteral">'3'</span>:
00778   <span class="keywordflow">case</span> <span class="charliteral">'4'</span>:
00779   <span class="keywordflow">case</span> <span class="charliteral">'5'</span>:
00780   <span class="keywordflow">case</span> <span class="charliteral">'6'</span>:
00781   <span class="keywordflow">case</span> <span class="charliteral">'7'</span>:
00782   <span class="keywordflow">case</span> <span class="charliteral">'8'</span>:
00783   <span class="keywordflow">case</span> <span class="charliteral">'9'</span>:
00784   <span class="keywordflow">case</span> <span class="charliteral">'-'</span>:
00785     {
00786       <span class="keywordtype">char</span> *s, *e;
00787 
00788       s = *str;
00789       e = strpbrk(s,<span class="stringliteral">") \t\n"</span>);
00790       <span class="keywordflow">if</span> (!e)
00791         e = s + strlen(s);
00792       
00793       
00794       s = strancpy(s,(size_t)(e-s));
00795 
00796       (*str)=e;
00797 
00798 <span class="preprocessor">#ifdef PARSER_DEBUG</span>
00799 <span class="preprocessor"></span>      printf(<span class="stringliteral">";; Number: [%s]\n"</span>,s);
00800 <span class="preprocessor">#endif</span>
00801 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (strcmp(s,<span class="stringliteral">"-"</span>)==0){
00802         token-&gt;data = dfsch_make_symbol(<span class="stringliteral">"-"</span>);
00803       }<span class="keywordflow">else</span>{
00804         token-&gt;data = dfsch_make_number(atof(s));
00805       }
00806       free(s);
00807 
00808       token-&gt;type=T_TERMINAL;
00809       <span class="keywordflow">return</span> 1;
00810     }
00811   <span class="keywordflow">case</span> <span class="charliteral">'"'</span>:
00812     {
00813       <span class="keywordtype">char</span> s[1024];
00814       <span class="keywordtype">char</span> *p=s;
00815       
00816       ++(*str);
00817 
00818       <span class="keywordflow">while</span> (1){
00819         <span class="keywordflow">if</span> (p&gt;s+1024)
00820           <span class="keywordflow">return</span> 0; <span class="comment">// overflow</span>
00821         
00822         <span class="keywordflow">switch</span> ((*str)[0]){
00823         <span class="keywordflow">case</span> <span class="charliteral">'"'</span>:
00824           *p=0;
00825           ++(*str);
00826 <span class="preprocessor">#ifdef PARSER_DEBUG</span>
00827 <span class="preprocessor"></span>          printf(<span class="stringliteral">";; String: \"%s\"\n"</span>,s);
00828 <span class="preprocessor">#endif</span>
00829 <span class="preprocessor"></span>          token-&gt;data = dfsch_make_string(s);
00830           token-&gt;type = T_TERMINAL;
00831           <span class="keywordflow">return</span> 1;
00832 
00833         <span class="keywordflow">case</span> <span class="charliteral">'\\'</span>:
00834           <span class="keywordflow">switch</span>((*str)[1]){
00835           <span class="keywordflow">case</span> 0:
00836             <span class="keywordflow">return</span> 0;
00837           <span class="keywordflow">default</span>:
00838             *p = (*str)[1];
00839             ++p;
00840           }
00841           
00842           ++(*str);
00843 
00844           <span class="keywordflow">break</span>;
00845 
00846         <span class="keywordflow">case</span> 0:
00847           <span class="keywordflow">return</span> 0;
00848           
00849         <span class="keywordflow">default</span>:
00850           *p = **str;
00851           ++p;
00852         } 
00853         ++(*str);
00854       }
00855       
00856     }
00857   <span class="keywordflow">case</span> <span class="charliteral">'('</span>:
00858     token-&gt;type=T_OPEN;
00859     ++(*str);    
00860     <span class="keywordflow">return</span> 1;
00861   <span class="keywordflow">case</span> <span class="charliteral">')'</span>:
00862     token-&gt;type=T_CLOSE;
00863     ++(*str);
00864     <span class="keywordflow">return</span> 1;
00865   <span class="keywordflow">case</span> <span class="charliteral">'\''</span>:
00866     token-&gt;type=T_QUOTE;
00867     ++(*str);
00868     <span class="keywordflow">return</span> 1;
00869   <span class="keywordflow">default</span>:
00870     
00871     {
00872       <span class="keywordtype">char</span> *s, *e;
00873       
00874       s = *str;
00875       e = strpbrk(s,<span class="stringliteral">") \t\n"</span>);
00876       <span class="keywordflow">if</span> (!e)
00877         e = s + strlen(s);
00878       
00879       (*str)=e;
00880 
00881       s = strancpy(s,(size_t)(e-s));
00882 
00883 <span class="preprocessor">#ifdef PARSER_DEBUG</span>
00884 <span class="preprocessor"></span>      printf(<span class="stringliteral">";; Symbol: %s\n"</span>,s);
00885 <span class="preprocessor">#endif</span>
00886 <span class="preprocessor"></span>      token-&gt;data = dfsch_make_symbol(s);
00887 
00888       free(s);
00889 
00890       token-&gt;type=T_TERMINAL;
00891       <span class="keywordflow">return</span> 1;
00892     }
00893 
00894   }
00895 }
00896 
00897 <span class="keyword">static</span> object_t* quote(object_t* d){
00898   <span class="keywordflow">return</span> dfsch_cons(dfsch_quote(),dfsch_cons(d, NULL));
00899 }
00900 
00901 
00902 <span class="keyword">static</span> object_t* one_obj_read(<span class="keywordtype">char</span>**str);
00903 <span class="keyword">static</span> <span class="keywordtype">int</span> one_obj_p(<span class="keywordtype">char</span> **str, token_t *t, object_t **o);
00904 
00905 <span class="keyword">static</span> object_t* parse_list(<span class="keywordtype">char</span> **str){
00906   
00907   token_t t;
00908   object_t *tmp;
00909   object_t *p = NULL;
00910   object_t *o;
00911   object_t *f = NULL; 
00912 
00913   <span class="keywordflow">if</span> (!get_token(&amp;t,str))
00914     <span class="keywordflow">return</span> 
00915       dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"parse-error:token-expected"</span>),
00916                           NULL);
00917   
00918   <span class="keywordflow">while</span> (t.type!=T_CLOSE){
00919 
00920     <span class="keywordflow">if</span> (one_obj_p(str, &amp;t, &amp;o)){
00921       <span class="keywordflow">if</span> (f){
00922         tmp = dfsch_cons(o,NULL);
00923         dfsch_set_cdr(p,tmp);
00924         p = tmp;
00925       }<span class="keywordflow">else</span>{
00926         f = p = dfsch_cons(o,NULL);
00927       }
00928     }<span class="keywordflow">else</span>{
00929       <span class="keywordflow">if</span> (t.type=T_DOT){
00930         <span class="keywordflow">if</span> (!f)
00931           <span class="keywordflow">return</span> 
00932             dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"parse-error:car-expected"</span>),
00933                                  NULL);
00934 
00935 
00936         dfsch_set_cdr(p,one_obj_read(str));
00937 
00938         <span class="keywordflow">if</span> (!get_token(&amp;t,str)){
00939           <span class="keywordflow">return</span> 
00940             dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"parse-error:token-expected"</span>),
00941                                  NULL);
00942         }
00943 
00944         <span class="keywordflow">if</span> (t.type!=T_CLOSE){
00945           <span class="keywordflow">return</span> 
00946             dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"parse-error:token-expected"</span>),
00947                                  dfsch_make_symbol(<span class="stringliteral">"T_CLOSE"</span>));
00948 
00949         }
00950 
00951 
00952         <span class="keywordflow">return</span> f;
00953         
00954       }<span class="keywordflow">else</span>{
00955         <span class="keywordflow">return</span> 
00956           dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"parse-error:unexpected-token"</span>),
00957                                NULL);
00958         
00959       }
00960     }
00961 
00962     <span class="keywordflow">if</span> (!get_token(&amp;t,str)){
00963       <span class="keywordflow">return</span> 
00964         dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"parse-error:token-expected"</span>),
00965                              NULL);
00966     }
00967 
00968   }
00969 
00970   <span class="keywordflow">return</span> f;
00971 }
00972 
00973 <span class="keyword">static</span> <span class="keywordtype">int</span> one_obj_p(<span class="keywordtype">char</span> **str, token_t *t, object_t **o){
00974 
00975   <span class="keywordflow">switch</span>(t-&gt;type){
00976   <span class="keywordflow">case</span> T_TERMINAL:
00977     *o = t-&gt;data;
00978     <span class="keywordflow">return</span> 1;
00979   <span class="keywordflow">case</span> T_QUOTE:
00980     *o = quote(one_obj_read(str));
00981     <span class="keywordflow">return</span> 1;
00982   <span class="keywordflow">case</span> T_OPEN:
00983     *o = parse_list(str);
00984     <span class="keywordflow">return</span> 1;
00985   <span class="keywordflow">default</span>:
00986     <span class="keywordflow">return</span> 0;
00987   }
00988 }
00989 
00990 <span class="keyword">static</span> object_t* one_obj_read(<span class="keywordtype">char</span>** str){
00991 
00992   token_t t;
00993   object_t *o;
00994   <span class="keywordflow">if</span> (!get_token(&amp;t,str))
00995     <span class="keywordflow">return</span> 
00996       dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"parse-error:token-expected"</span>),
00997                            NULL);
00998   <span class="keywordflow">if</span> (one_obj_p(str, &amp;t,&amp;o)){
00999     <span class="keywordflow">return</span> o;
01000   }<span class="keywordflow">else</span>{
01001     <span class="keywordflow">return</span> 
01002       dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"parse-error:unexpected-token"</span>),
01003                           NULL);
01004   }
01005 
01006 }
01007 
01008 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_obj_read(<span class="keywordtype">char</span>* str){
01009 
01010   <span class="keywordflow">return</span> one_obj_read(&amp;str);
01011 
01012 }
01013 
01014 <span class="keywordtype">char</span>* dfsch_obj_write(dfsch_object_t* obj, <span class="keywordtype">int</span> max_depth){
01015   <span class="keywordflow">if</span> (!obj){
01016     <span class="keywordflow">return</span> stracpy(<span class="stringliteral">"()"</span>);
01017   }
01018 
01019   <span class="keywordflow">if</span> (max_depth==0){
01020     <span class="keywordflow">return</span> stracpy(<span class="stringliteral">"..."</span>);
01021   }
01022 
01023   <span class="keywordflow">switch</span> (obj-&gt;type){
01024   <span class="keywordflow">case</span> NUMBER:
01025     {
01026       <span class="keywordtype">char</span>  *s = malloc(512);
01027       snprintf(s, 512, <span class="stringliteral">"%lf"</span>, obj-&gt;data.number);
01028       <span class="keywordflow">return</span> s;
01029     }
01030   <span class="keywordflow">case</span> SYMBOL:
01031     {
01032       <span class="keywordflow">return</span> stracpy(dfsch_symbol(obj));
01033     }
01034   <span class="keywordflow">case</span> STRING:
01035     <span class="keywordflow">return</span> straquote(obj-&gt;data.string);
01036   <span class="keywordflow">case</span> PRIMITIVE:
01037     <span class="keywordflow">return</span> stracpy(<span class="stringliteral">"&lt;native-code&gt;"</span>);
01038   <span class="keywordflow">case</span> CLOSURE:
01039     <span class="keywordflow">return</span> stracpy(<span class="stringliteral">"&lt;closure&gt;"</span>);  <span class="comment">// TODO: maybe dump some data?</span>
01040   <span class="keywordflow">case</span> MACRO:
01041     <span class="keywordflow">return</span> strneko(strneko_r(<span class="stringliteral">"&lt;macro: "</span>,
01042                              dfsch_obj_write(obj-&gt;data.macro,max_depth-1)),
01043                    <span class="stringliteral">"&gt;"</span>);
01044   <span class="keywordflow">case</span> EXCEPTION:
01045     <span class="keywordflow">return</span> strneko(strneko_r(<span class="stringliteral">"&lt;exception: "</span>,
01046                              dfsch_obj_write(obj-&gt;data.exception.type,
01047                                              max_depth-1)),
01048                    strneko_l(strneko_r(<span class="stringliteral">" . "</span>,
01049                                        dfsch_obj_write(obj-&gt;data.exception.data,
01050                                                        max_depth-1)),
01051                              <span class="stringliteral">"&gt;"</span>));
01052  
01053   <span class="keywordflow">case</span> PAIR: 
01054     <span class="comment">// TODO: at least semi-iterative solution? </span>
01055     {
01056       <span class="keywordflow">if</span> (obj-&gt;data.pair.cdr &amp;&amp; obj-&gt;data.pair.cdr-&gt;type!=PAIR)
01057         <span class="keywordflow">return</span> strneko(strneko_r(<span class="stringliteral">"("</span>,
01058                                  dfsch_obj_write(obj-&gt;data.pair.car,
01059                                                  max_depth-1)),
01060                        strneko_l(strneko_r(<span class="stringliteral">" . "</span>,
01061                                            dfsch_obj_write(obj-&gt;data.pair.cdr,
01062                                                            max_depth-1)),
01063                                  <span class="stringliteral">")"</span>));
01064       {
01065         <span class="keywordtype">char</span> *s=malloc(2);
01066         object_t* i=obj;
01067         
01068         strncpy(s,<span class="stringliteral">"("</span>,2);
01069 
01070         <span class="keywordflow">while</span> (i &amp;&amp; i-&gt;type==PAIR){
01071           
01072           s = strneko(s, dfsch_obj_write(i-&gt;data.pair.car,max_depth-1));
01073           i = i-&gt;data.pair.cdr;
01074 
01075           <span class="keywordflow">if</span> (i)
01076             s = strneko_l(s,<span class="stringliteral">" "</span>);
01077             
01078         }
01079 
01080         <span class="keywordflow">if</span> (i){
01081           s = strneko_l(s,<span class="stringliteral">". "</span>);
01082           s = strneko(s, dfsch_obj_write(i,max_depth-1));
01083         }
01084 
01085         <span class="keywordflow">return</span> strneko_l(s,<span class="stringliteral">")"</span>);
01086       }
01087     }
01088   <span class="keywordflow">default</span>:
01089     {
01090       <span class="keywordflow">return</span> stracpy(<span class="stringliteral">"&lt;native-object&gt;"</span>);
01091     }
01092   }
01093 }
01094 
01095 <span class="comment">// EVAL + APPLY</span>
01096 
01097 object_t* <a class="code" href="dfsch_8h.html#a41">dfsch_lookup</a>(object_t* name, object_t* env){
01098   object_t *i, *ie;
01099   <span class="keywordflow">if</span> (!env || env-&gt;type!=PAIR)
01100     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-pair"</span>),
01101                                 env);
01102 
01103   ie = env;
01104   <span class="keywordflow">while</span> (ie &amp;&amp; ie-&gt;type==PAIR){
01105     i = ie-&gt;data.pair.car;
01106     <span class="keywordflow">while</span> (i &amp;&amp; i-&gt;type==PAIR){
01107       <span class="keywordflow">if</span> (!i-&gt;data.pair.car || i-&gt;data.pair.car-&gt;type!=PAIR){
01108         <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-alist"</span>),
01109                                     ie);
01110       }
01111       
01112       <span class="keywordflow">if</span> (dfsch_eq_p(name,i-&gt;data.pair.car-&gt;data.pair.car)){
01113         <span class="keywordflow">if</span> (!i-&gt;data.pair.car-&gt;data.pair.cdr || 
01114             i-&gt;data.pair.car-&gt;data.pair.cdr-&gt;type!=PAIR)
01115           <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-alist"</span>),
01116                                       ie);
01117         
01118         <span class="keywordflow">return</span> i-&gt;data.pair.car-&gt;data.pair.cdr-&gt;data.pair.car;
01119       }
01120       
01121       i = i-&gt;data.pair.cdr;
01122       
01123     }
01124     ie = ie-&gt;data.pair.cdr;
01125   }
01126   
01127 
01128   <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:unbound-variable"</span>),
01129                               name);
01130   
01131 
01132 }
01133 
01134 
01135 object_t* <a class="code" href="dfsch_8h.html#a42">dfsch_set</a>(object_t* name, object_t* value, object_t* env){
01136   object_t *i, *ie;
01137   <span class="keywordflow">if</span> (!env || env-&gt;type!=PAIR)
01138     <span class="keywordflow">return</span> 0;
01139 
01140   ie = env;
01141   <span class="keywordflow">while</span> (ie &amp;&amp; ie-&gt;type==PAIR){
01142     i = ie-&gt;data.pair.car;
01143     <span class="keywordflow">while</span> (i &amp;&amp; i-&gt;type==PAIR){
01144       <span class="keywordflow">if</span> (!i-&gt;data.pair.car || i-&gt;data.pair.car-&gt;type!=PAIR){
01145         <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-alist"</span>),
01146                                     ie);
01147       }
01148       
01149       <span class="keywordflow">if</span> (dfsch_eq_p(name,i-&gt;data.pair.car-&gt;data.pair.car)){
01150         <span class="keywordflow">if</span> (!i-&gt;data.pair.car-&gt;data.pair.cdr || 
01151             i-&gt;data.pair.car-&gt;data.pair.cdr-&gt;type!=PAIR)
01152           <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-alist"</span>),
01153                                       ie);
01154         dfsch_set_car(i-&gt;data.pair.car-&gt;data.pair.cdr,value);
01155         <span class="keywordflow">return</span> value;
01156       }
01157       
01158       i = i-&gt;data.pair.cdr;
01159       
01160     }
01161     ie = ie-&gt;data.pair.cdr;
01162   }
01163   
01164 
01165   <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:unbound-variable"</span>),
01166                               name);
01167   
01168 
01169 }
01170 
01171 <span class="keyword">static</span> <span class="keywordtype">void</span> define(object_t* name, object_t* value, object_t* env){
01172 
01173   object_t *o, *d;
01174 
01175   o = env-&gt;data.pair.car;
01176   d = dfsch_cons(name,dfsch_cons(value,NULL));
01177   dfsch_set_car(env,dfsch_cons(d,o));
01178 
01179 }
01180 
01181 object_t* <a class="code" href="dfsch_8h.html#a43">dfsch_define</a>(object_t* name, object_t* value, object_t* env){
01182   <span class="keywordflow">if</span> (!env || env-&gt;type!=PAIR)
01183     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-pair"</span>),
01184                                 env);
01185 
01186   define(name,value,env);
01187   
01188   <span class="keywordflow">return</span> value;
01189 
01190 }
01191 
01192 
01193 <span class="keyword">static</span> object_t* eval_list(object_t *list, object_t* env){
01194   object_t *i;
01195   object_t *f=NULL;
01196   object_t *t, *p;
01197 
01198 
01199   <span class="keywordflow">if</span> (!list)
01200     <span class="keywordflow">return</span> NULL;
01201 
01202   <span class="keywordflow">if</span> (list-&gt;type!=PAIR){
01203     <span class="keywordflow">return</span> dfsch_eval(list,env);
01204   }
01205 
01206   <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(list);
01207   <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(env);
01208 
01209   i = list;
01210   <span class="keywordflow">while</span> (i &amp;&amp; i-&gt;type==PAIR){
01211     t = dfsch_cons(dfsch_eval(i-&gt;data.pair.car,
01212                               env),
01213                    NULL);
01214 
01215     <span class="keywordflow">if</span> (f){
01216       dfsch_set_cdr(p,t);
01217       p = t;
01218     }<span class="keywordflow">else</span>{
01219       <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(f = p = t);
01220     }
01221 
01222     i=i-&gt;data.pair.cdr;
01223   }
01224   <a class="code" href="dfsch_8h.html#a8">dfsch_object_unref</a>(list);
01225   <a class="code" href="dfsch_8h.html#a8">dfsch_object_unref</a>(env);
01226   <a class="code" href="dfsch_8h.html#a8">dfsch_object_unref</a>(f);
01227 
01228   <span class="keywordflow">return</span> f;
01229 }
01230 
01231 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_eval(dfsch_object_t* exp, dfsch_object_t* env){
01232   <span class="keywordflow">if</span> (!exp) 
01233     <span class="keywordflow">return</span> NULL;
01234 
01235   <span class="keywordflow">switch</span> (exp-&gt;type){
01236   <span class="keywordflow">case</span> PAIR:
01237     {
01238 
01239       object_t *f = dfsch_eval(exp-&gt;data.pair.car,env);
01240       
01241       <span class="keywordflow">switch</span>(f-&gt;type){
01242       <span class="keywordflow">case</span> MACRO:
01243         <span class="keywordflow">return</span> dfsch_apply(f-&gt;data.macro,     
01244                            dfsch_cons(env,
01245                                       exp-&gt;data.pair.cdr));
01246       <span class="keywordflow">case</span> FLOW_MACRO:
01247         <span class="keywordflow">return</span> dfsch_eval(dfsch_apply(f-&gt;data.macro,     
01248                                       dfsch_cons(env,
01249                                                  exp-&gt;data.pair.cdr)),env);
01250         
01251       <span class="keywordflow">case</span> CLOSURE:
01252       <span class="keywordflow">case</span> PRIMITIVE:
01253         <span class="keywordflow">return</span> dfsch_apply(f, 
01254                            eval_list(exp-&gt;data.pair.cdr,env));
01255       }
01256 
01257       <span class="keywordflow">return</span> 
01258         dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-procedure-or-macro"</span>),
01259                              f);
01260 
01261       
01262     }
01263   <span class="keywordflow">case</span> SYMBOL:
01264     <span class="keywordflow">return</span> <a class="code" href="dfsch_8h.html#a41">dfsch_lookup</a>(exp,env);
01265   <span class="keywordflow">default</span>:
01266     <span class="keywordflow">return</span> exp;
01267   }
01268 }
01269 
01270 <span class="keyword">static</span> object_t* lambda_extend(object_t* fa, object_t* aa, object_t* env){
01271   object_t* f=NULL;
01272   object_t* i_f=fa;
01273   object_t* i_a=aa;
01274 
01275   <span class="keywordflow">while</span> ((i_f &amp;&amp; i_f-&gt;type==PAIR) &amp;&amp;
01276          (i_a &amp;&amp; i_a-&gt;type==PAIR)){
01277 
01278     f = dfsch_cons(dfsch_cons(i_f-&gt;data.pair.car,
01279                               dfsch_cons(i_a-&gt;data.pair.car,
01280                                          NULL)),
01281                    f);
01282 
01283     i_f = i_f-&gt;data.pair.cdr;
01284     i_a = i_a-&gt;data.pair.cdr;
01285     
01286   }
01287 
01288   <span class="keywordflow">if</span> (i_f &amp;&amp; i_f-&gt;type==SYMBOL){
01289     f = dfsch_cons(dfsch_cons(i_f,
01290                               dfsch_cons(i_a,
01291                                          NULL)),
01292                    f);
01293   }
01294 
01295   <span class="keywordflow">if</span> (!i_a  &amp;&amp; i_f)
01296     <span class="keywordflow">return</span> 
01297       dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:too-few-arguments"</span>),
01298                            aa);
01299   <span class="keywordflow">if</span> (!i_f &amp;&amp; i_a)
01300     <span class="keywordflow">return</span> 
01301       dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:too-many-arguments"</span>),
01302                            aa);
01303   
01304 
01305   <span class="keywordflow">return</span> dfsch_cons(f,env);
01306 }
01307 
01308 <span class="keyword">static</span> object_t* eval_proc(object_t* code, object_t* env){
01309   object_t *i, *r;
01310 
01311 
01312   <span class="keywordflow">if</span> (!env)
01313     <span class="keywordflow">return</span> NULL;
01314   <span class="keywordflow">if</span> (env-&gt;type==EXCEPTION)
01315     <span class="keywordflow">return</span> env;
01316 
01317   <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(code);
01318   <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(env);
01319 
01320   i = code;
01321 
01322   <span class="keywordflow">while</span> (i &amp;&amp; i-&gt;type==PAIR ){
01323     object_t* exp = i-&gt;data.pair.car; 
01324 
01325     r = dfsch_eval(exp,env);
01326     
01327     i = i-&gt;data.pair.cdr;
01328   }
01329 
01330   <a class="code" href="dfsch_8h.html#a8">dfsch_object_unref</a>(code);
01331   <a class="code" href="dfsch_8h.html#a8">dfsch_object_unref</a>(env);
01332   
01333   <span class="keywordflow">return</span> r;
01334 }
01335 
01336 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_apply(dfsch_object_t* proc, dfsch_object_t* args){
01337   <span class="keywordflow">if</span> (!proc)
01338     <span class="keywordflow">return</span> NULL;
01339   <span class="keywordflow">if</span> (proc-&gt;type==EXCEPTION)
01340     <span class="keywordflow">return</span> proc;
01341 
01342   <span class="keywordflow">switch</span> (proc-&gt;type){
01343   <span class="keywordflow">case</span> CLOSURE:
01344     <span class="keywordflow">return</span> eval_proc(proc-&gt;data.closure.code,
01345                      lambda_extend(proc-&gt;data.closure.args,
01346                                    args,
01347                                    proc-&gt;data.closure.env));
01348     
01349   <span class="keywordflow">case</span> PRIMITIVE:
01350     <span class="keywordflow">return</span> (*proc-&gt;data.primitive)(args);
01351   <span class="keywordflow">default</span>:
01352     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-procedure"</span>),
01353                                 proc);
01354 
01355   }  
01356 }
01357 
01358 
01359 <span class="comment">// Native procedures:</span>
01360 
01361 <span class="keyword">static</span> object_t* native_plus(object_t* args){
01362   object_t* i = args;
01363   <span class="keywordtype">double</span> s=0;
01364   <span class="keywordflow">while</span>(i &amp;&amp; i-&gt;type==PAIR){
01365     <span class="keywordflow">if</span> (dfsch_object_number_p(dfsch_car(i))){
01366       s+=dfsch_number(i-&gt;data.pair.car);
01367     }<span class="keywordflow">else</span>{
01368       <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-number"</span>),
01369                                   i-&gt;data.pair.car);
01370       
01371     }
01372     i = i-&gt;data.pair.cdr;
01373   }
01374 
01375   <span class="keywordflow">return</span> dfsch_make_number(s); 
01376 }
01377 <span class="keyword">static</span> object_t* native_minus(object_t* args){
01378   object_t* i = args;
01379   <span class="keywordtype">double</span> s;
01380   <span class="keywordflow">if</span> (dfsch_object_number_p(dfsch_car(i))){
01381     s=dfsch_number(i-&gt;data.pair.car);
01382   }<span class="keywordflow">else</span>{
01383     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-number"</span>),
01384                                 i-&gt;data.pair.car);
01385     
01386   }
01387   i = i-&gt;data.pair.cdr;
01388   <span class="keywordflow">while</span>(i &amp;&amp; i-&gt;type==PAIR){
01389     <span class="keywordflow">if</span> (dfsch_object_number_p(dfsch_car(i))){
01390       s-=dfsch_number(i-&gt;data.pair.car);
01391     }<span class="keywordflow">else</span>{
01392       <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-number"</span>),
01393                                   i-&gt;data.pair.car);
01394       
01395     }
01396     i = i-&gt;data.pair.cdr;
01397   }
01398 
01399   <span class="keywordflow">return</span> dfsch_make_number(s); 
01400 }
01401 <span class="keyword">static</span> object_t* native_mult(object_t* args){
01402   object_t* i = args;
01403   <span class="keywordtype">double</span> s=1;
01404   <span class="keywordflow">while</span>(i &amp;&amp; i-&gt;type==PAIR){
01405     <span class="keywordflow">if</span> (dfsch_object_number_p(dfsch_car(i))){
01406       s*=dfsch_number(i-&gt;data.pair.car);
01407     }<span class="keywordflow">else</span>{
01408       <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-number"</span>),
01409                                   i-&gt;data.pair.car);
01410       
01411     }
01412     i = i-&gt;data.pair.cdr;
01413   }
01414 
01415   <span class="keywordflow">return</span> dfsch_make_number(s); 
01416 }
01417 <span class="keyword">static</span> object_t* native_slash(object_t* args){
01418   object_t* i = args;
01419   <span class="keywordtype">double</span> s;
01420   <span class="keywordflow">if</span> (dfsch_object_number_p(dfsch_car(i))){
01421     s=dfsch_number(i-&gt;data.pair.car);
01422   }<span class="keywordflow">else</span>{
01423     <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-number"</span>),
01424                                 i-&gt;data.pair.car);
01425     
01426   }
01427   i = i-&gt;data.pair.cdr;
01428   
01429   <span class="keywordflow">while</span>(i &amp;&amp; i-&gt;type==PAIR){
01430     <span class="keywordflow">if</span> (i-&gt;data.pair.car-&gt;type==NUMBER){
01431       s/=dfsch_number(i-&gt;data.pair.car);
01432     }<span class="keywordflow">else</span>{
01433       <span class="keywordflow">return</span> dfsch_make_exception(dfsch_make_symbol(<span class="stringliteral">"exception:not-a-number"</span>),
01434                                   i-&gt;data.pair.car);
01435       
01436     }
01437     i = i-&gt;data.pair.cdr;
01438   }
01439 
01440   <span class="keywordflow">return</span> dfsch_make_number(s); 
01441 }
01442 
01443 <span class="keyword">static</span> object_t* native_macro_lambda(object_t* args){
01444   
01445   <span class="keywordflow">return</span> dfsch_lambda(dfsch_car(args),
01446                       dfsch_car(dfsch_cdr(args)),
01447                       dfsch_cdr(dfsch_cdr(args)));
01448 
01449 }
01450 
01451 <span class="keyword">static</span> object_t* native_macro_define(object_t* args){
01452   
01453   object_t* env = dfsch_car(args);
01454   object_t* name = dfsch_car(dfsch_cdr(args));
01455 
01456   <span class="keywordflow">if</span> (dfsch_object_pair_p(name)){
01457     object_t* lambda = dfsch_lambda(env,dfsch_cdr(name),
01458                                     dfsch_cdr(dfsch_cdr(args)));
01459     define(dfsch_car(name), lambda ,env);
01460     <span class="keywordflow">return</span> lambda;
01461   }<span class="keywordflow">else</span>{
01462     object_t* value = dfsch_eval(dfsch_car(dfsch_cdr(dfsch_cdr(args))),env);
01463     define(name,value,env);
01464     <span class="keywordflow">return</span> value;
01465   }
01466 
01467 }
01468 <span class="keyword">static</span> object_t* native_macro_set(object_t* args){
01469   
01470   object_t* env = dfsch_car(args);
01471   object_t* name = dfsch_car(dfsch_cdr(args));
01472   object_t* value = dfsch_eval(dfsch_car(dfsch_cdr(dfsch_cdr(args))),env);
01473 
01474   <span class="keywordflow">return</span> <a class="code" href="dfsch_8h.html#a42">dfsch_set</a>(name, value, env);
01475 
01476 }
01477 <span class="keyword">static</span> object_t* native_flow_macro_if(object_t* args){
01478   
01479   object_t* env = dfsch_car(args);
01480   object_t* cond = dfsch_car(dfsch_cdr(args));
01481   object_t* <span class="keyword">true</span> = dfsch_car(dfsch_cdr(dfsch_cdr(args)));
01482   object_t* <span class="keyword">false</span> = dfsch_car(dfsch_cdr(dfsch_cdr(dfsch_cdr(args))));
01483 
01484   <span class="keywordflow">return</span> dfsch_eval(cond,env)?<span class="keyword">true</span>:<span class="keyword">false</span>;
01485 }
01486 
01487 <span class="keyword">static</span> object_t* native_flow_macro_cond(object_t* args){
01488   
01489   object_t* env = dfsch_car(args);
01490   object_t* i = dfsch_cdr(args);
01491 
01492   <span class="keywordflow">while</span> (i &amp;&amp; i-&gt;type == PAIR){
01493     <span class="keywordflow">if</span> (dfsch_eval(dfsch_car(i-&gt;data.pair.car), env)){
01494       <span class="keywordflow">return</span> dfsch_car(dfsch_cdr(i-&gt;data.pair.car));
01495     }
01496     
01497     i = i-&gt;data.pair.cdr; 
01498   }
01499 
01500   <span class="keywordflow">return</span> NULL;
01501 }
01502 
01503 
01504 <span class="keyword">static</span> object_t* native_macro_env(object_t* args){
01505   <span class="keywordflow">return</span> dfsch_car(args);
01506 }
01507 
01508 <span class="keyword">static</span> object_t* native_macro_quote(object_t* args){
01509   <span class="keywordflow">return</span> dfsch_car(dfsch_cdr(args));
01510 }
01511 
01512 
01513 
01514 <span class="keyword">static</span> object_t* native_make_macro(object_t* args){
01515   <span class="keywordflow">return</span> <a class="code" href="dfsch_8h.html#a39">dfsch_make_macro</a>(dfsch_car(args));
01516 }
01517 <span class="keyword">static</span> object_t* native_car(object_t* args){
01518   <span class="keywordflow">return</span> dfsch_car(dfsch_car(args));
01519 }
01520 <span class="keyword">static</span> object_t* native_cdr(object_t* args){
01521   <span class="keywordflow">return</span> dfsch_cdr(dfsch_car(args));
01522 }
01523 <span class="keyword">static</span> object_t* native_cons(object_t* args){
01524   <span class="keywordflow">return</span> dfsch_cons(dfsch_car(args),dfsch_car(dfsch_cdr(args)));
01525 }
01526 <span class="keyword">static</span> object_t* native_eq(object_t* args){
01527   <span class="keywordflow">return</span> dfsch_eq_p(dfsch_car(args),dfsch_car(dfsch_cdr(args)))?
01528     dfsch_true():
01529     NULL;
01530 }
01531 <span class="keyword">static</span> object_t* native_set_car(object_t* args){
01532   <span class="keywordflow">return</span> dfsch_set_car(dfsch_car(args),dfsch_car(dfsch_cdr(args)));  
01533 }
01534 <span class="keyword">static</span> object_t* native_set_cdr(object_t* args){
01535   <span class="keywordflow">return</span> dfsch_set_cdr(dfsch_car(args),dfsch_car(dfsch_cdr(args)));  
01536 }
01537 
01538 <span class="keyword">static</span> object_t* native_null_p(object_t* args){
01539   <span class="keywordflow">return</span> dfsch_object_null_p(dfsch_car(args))?
01540     dfsch_true():
01541     NULL;  
01542 }
01543 <span class="keyword">static</span> object_t* native_pair_p(object_t* args){
01544   <span class="keywordflow">return</span> dfsch_object_pair_p(dfsch_car(args))?
01545     dfsch_true():
01546     NULL;  
01547 }
01548 <span class="keyword">static</span> object_t* native_atom_p(object_t* args){
01549   <span class="keywordflow">return</span> dfsch_object_atom_p(dfsch_car(args))?
01550     dfsch_true():
01551     NULL;  
01552 }
01553 <span class="keyword">static</span> object_t* native_symbol_p(object_t* args){
01554   <span class="keywordflow">return</span> dfsch_object_symbol_p(dfsch_car(args))?
01555     dfsch_true():
01556     NULL;  
01557 }
01558 <span class="keyword">static</span> object_t* native_number_p(object_t* args){
01559   <span class="keywordflow">return</span> dfsch_object_number_p(dfsch_car(args))?
01560     dfsch_true():
01561     NULL;  
01562 }
01563 <span class="keyword">static</span> object_t* native_string_p(object_t* args){
01564   <span class="keywordflow">return</span> dfsch_object_string_p(dfsch_car(args))?
01565     dfsch_true():
01566     NULL;  
01567 }
01568 <span class="keyword">static</span> object_t* native_primitive_p(object_t* args){
01569   <span class="keywordflow">return</span> dfsch_object_primitive_p(dfsch_car(args))?
01570     dfsch_true():
01571     NULL;  
01572 }
01573 <span class="keyword">static</span> object_t* native_closure_p(object_t* args){
01574   <span class="keywordflow">return</span> dfsch_object_closure_p(dfsch_car(args))?
01575     dfsch_true():
01576     NULL;  
01577 }
01578 <span class="keyword">static</span> object_t* native_procedure_p(object_t* args){
01579   <span class="keywordflow">return</span> dfsch_object_procedure_p(dfsch_car(args))?
01580     dfsch_true():
01581     NULL;  
01582 }
01583 <span class="keyword">static</span> object_t* native_macro_p(object_t* args){
01584   <span class="keywordflow">return</span> dfsch_object_macro_p(dfsch_car(args))?
01585     dfsch_true():
01586     NULL;  
01587 }
01588 <span class="keyword">static</span> object_t* native_exception_p(object_t* args){
01589   <span class="keywordflow">return</span> dfsch_object_exception_p(dfsch_car(args))?
01590     dfsch_true():
01591     NULL;  
01592 }
01593 <span class="keyword">static</span> object_t* native_inspect_closure(object_t* args){
01594   object_t* clos = dfsch_car(args);
01595   <span class="keywordflow">if</span> (!dfsch_object_closure_p(clos))
01596     <span class="keywordflow">return</span> dfsch_make_exception(NULL,NULL);
01597 
01598   <span class="keywordflow">return</span> dfsch_cons(clos-&gt;data.closure.args, 
01599                     dfsch_cons(clos-&gt;data.closure.code,
01600                                dfsch_cons(clos-&gt;data.closure.env,
01601                                           NULL)));
01602 }
01603 
01604 <span class="keyword">static</span> object_t* native_gc(object_t* args){
01605   <span class="keywordflow">return</span> dfsch_make_number((<span class="keywordtype">double</span>)dfsch_gc());
01606 }
01607 
01608 <span class="comment">// Context</span>
01609 
01610 
01611 <a class="code" href="dfsch_8h.html#a2">dfsch_ctx_t</a>* dfsch_make_context(){
01612   <a class="code" href="dfsch_8h.html#a2">dfsch_ctx_t</a>* ctx=malloc(<span class="keyword">sizeof</span>(dfsch_ctx_t));
01613   <span class="keywordflow">if</span> (!ctx)
01614     <span class="keywordflow">return</span> NULL;
01615 
01616   ctx-&gt;env = dfsch_cons(NULL,
01617                         NULL);
01618 
01619   
01620   dfsch_ctx_define(ctx, <span class="stringliteral">"+"</span>, dfsch_make_primitive(&amp;native_plus));
01621   dfsch_ctx_define(ctx, <span class="stringliteral">"-"</span>, dfsch_make_primitive(&amp;native_minus));
01622   dfsch_ctx_define(ctx, <span class="stringliteral">"*"</span>, dfsch_make_primitive(&amp;native_mult));
01623   dfsch_ctx_define(ctx, <span class="stringliteral">"/"</span>, dfsch_make_primitive(&amp;native_slash));
01624   dfsch_ctx_define(ctx, <span class="stringliteral">"="</span>, dfsch_make_primitive(&amp;native_eq));
01625 
01626   dfsch_ctx_define(ctx, <span class="stringliteral">"lambda"</span>, 
01627                    <a class="code" href="dfsch_8h.html#a39">dfsch_make_macro</a>(dfsch_make_primitive(&amp;native_macro_lambda)));
01628   dfsch_ctx_define(ctx, <span class="stringliteral">"define"</span>, 
01629                    <a class="code" href="dfsch_8h.html#a39">dfsch_make_macro</a>(dfsch_make_primitive(&amp;native_macro_define)));
01630   dfsch_ctx_define(ctx, <span class="stringliteral">"set!"</span>, 
01631                    <a class="code" href="dfsch_8h.html#a39">dfsch_make_macro</a>(dfsch_make_primitive(&amp;native_macro_set)));
01632   dfsch_ctx_define(ctx, <span class="stringliteral">"env"</span>, 
01633                    <a class="code" href="dfsch_8h.html#a39">dfsch_make_macro</a>(dfsch_make_primitive(&amp;native_macro_env)));
01634   dfsch_ctx_define(ctx, <span class="stringliteral">"quote"</span>, 
01635                    <a class="code" href="dfsch_8h.html#a39">dfsch_make_macro</a>(dfsch_make_primitive(&amp;native_macro_quote)));
01636   dfsch_ctx_define(ctx, <span class="stringliteral">"if"</span>, 
01637                    dfsch_make_flow_macro(dfsch_make_primitive(&amp;native_flow_macro_if)));
01638   dfsch_ctx_define(ctx, <span class="stringliteral">"cond"</span>, 
01639                    dfsch_make_flow_macro(dfsch_make_primitive(&amp;native_flow_macro_cond)));
01640 
01641   dfsch_ctx_define(ctx, <span class="stringliteral">"make-macro"</span>, dfsch_make_primitive(&amp;native_make_macro));
01642   dfsch_ctx_define(ctx, <span class="stringliteral">"cons"</span>, dfsch_make_primitive(&amp;native_cons));
01643   dfsch_ctx_define(ctx, <span class="stringliteral">"car"</span>, dfsch_make_primitive(&amp;native_car));
01644   dfsch_ctx_define(ctx, <span class="stringliteral">"cdr"</span>, dfsch_make_primitive(&amp;native_cdr));
01645   dfsch_ctx_define(ctx, <span class="stringliteral">"set-car!"</span>, dfsch_make_primitive(&amp;native_set_car));
01646   dfsch_ctx_define(ctx, <span class="stringliteral">"set-cdr!"</span>, dfsch_make_primitive(&amp;native_set_cdr));
01647 
01648   dfsch_ctx_define(ctx, <span class="stringliteral">"null?"</span>, dfsch_make_primitive(&amp;native_null_p));
01649   dfsch_ctx_define(ctx, <span class="stringliteral">"atom?"</span>, dfsch_make_primitive(&amp;native_atom_p));
01650   dfsch_ctx_define(ctx, <span class="stringliteral">"pair?"</span>, dfsch_make_primitive(&amp;native_pair_p));
01651   dfsch_ctx_define(ctx, <span class="stringliteral">"symbol?"</span>, dfsch_make_primitive(&amp;native_symbol_p));
01652   dfsch_ctx_define(ctx, <span class="stringliteral">"number?"</span>, dfsch_make_primitive(&amp;native_number_p));
01653   dfsch_ctx_define(ctx, <span class="stringliteral">"string?"</span>, dfsch_make_primitive(&amp;native_string_p));
01654   dfsch_ctx_define(ctx, <span class="stringliteral">"primitive?"</span>, 
01655                    dfsch_make_primitive(&amp;native_primitive_p));
01656   dfsch_ctx_define(ctx, <span class="stringliteral">"closure?"</span>, dfsch_make_primitive(&amp;native_closure_p));
01657   dfsch_ctx_define(ctx, <span class="stringliteral">"prcedure?"</span>, 
01658                    dfsch_make_primitive(&amp;native_procedure_p));
01659   dfsch_ctx_define(ctx, <span class="stringliteral">"macro?"</span>, dfsch_make_primitive(&amp;native_macro_p));
01660   dfsch_ctx_define(ctx, <span class="stringliteral">"exception?"</span>, 
01661                    dfsch_make_primitive(&amp;native_exception_p));
01662 
01663   dfsch_ctx_define(ctx, <span class="stringliteral">"gc"</span>, 
01664                    dfsch_make_primitive(&amp;native_gc));
01665 
01666 
01667   dfsch_ctx_define(ctx, <span class="stringliteral">"true"</span>, dfsch_true());
01668   dfsch_ctx_define(ctx, <span class="stringliteral">"nil"</span>, NULL);
01669   dfsch_ctx_define(ctx, <span class="stringliteral">"else"</span>, dfsch_true());
01670   dfsch_ctx_define(ctx, <span class="stringliteral">"T"</span>, dfsch_true());
01671 
01672 
01673 
01674   <a class="code" href="dfsch_8h.html#a7">dfsch_object_ref</a>(ctx-&gt;env);
01675 
01676   <span class="keywordflow">return</span> ctx;
01677 }
01678 <a class="code" href="dfsch_8h.html#a3">dfsch_object_t</a>* dfsch_ctx_eval(dfsch_ctx_t* ctx, dfsch_object_t* exp){
01679   <span class="keywordflow">return</span> dfsch_eval(exp, ctx-&gt;env);
01680 }
01681 <span class="keywordtype">void</span> dfsch_destroy_context(dfsch_ctx_t* ctx){
01682   <a class="code" href="dfsch_8h.html#a8">dfsch_object_unref</a>(ctx-&gt;env);
01683   free(ctx);
01684 }
01685 <span class="keywordtype">void</span> dfsch_ctx_define(dfsch_ctx_t *ctx, 
01686                       <span class="keywordtype">char</span> *name, 
01687                       dfsch_object_t *obj){
01688   
01689   object_t *o,*d;
01690 
01691 
01692   o = ctx-&gt;env-&gt;data.pair.car;
01693   d = dfsch_cons(dfsch_make_symbol(name),dfsch_cons(obj,NULL));
01694   dfsch_set_car(ctx-&gt;env,dfsch_cons(d,o));
01695   
01696 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 24 18:27:18 2005 for dfsch by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
